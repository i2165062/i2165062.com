<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Web90 â€” Create Your On-Chain Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.10.0/ethers.umd.min.js"></script>

  <style>
    body {
      direction: rtl;
      margin: 0;
      padding: 0;
      font-family: Tahoma, Verdana, sans-serif;
      background:
        url("https://i.imgur.com/ybD1aSm.gif") repeat,
        linear-gradient(135deg, #222244, #111119);
      color: #111;
    }
    .shell {
      max-width: 900px;
      margin: 30px auto;
      border: 4px double #000;
      background: #d9d9d9;
      box-shadow: 0 0 25px rgba(0,0,0,.7);
    }
    .titlebar {
      background: linear-gradient(to right, #0055ff, #88ccff);
      color: #fff;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }
    .titlebar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .win-btns {
      display: flex;
      gap: 4px;
    }
    .win-btn {
      width: 14px;
      height: 14px;
      border: 2px outset #ddd;
      background: #ccc;
    }
    .inner {
      padding: 16px;
      border-top: 3px groove #fff;
    }
    h1 {
      text-align: center;
      margin-top: 0;
      font-size: 26px;
      text-shadow: 0 0 4px #fff;
    }
    h1 span {
      font-size: 18px;
      display: block;
      margin-top: 4px;
    }
    .btn {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      background: #e0e0e0;
      border: 2px solid #555;
      cursor: pointer;
      margin: 8px 0;
    }
    .btn:hover {
      background: #f5f5f5;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 2px inset #aaa;
      background: #fff;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      padding: 8px;
      font-size: 13px;
      border: 2px inset #aaa;
      background: #fff;
      resize: vertical;
      direction: ltr;
      font-family: Consolas, "Courier New", monospace;
    }
    .section {
      margin-top: 16px;
      padding: 10px;
      border: 2px ridge #aaa;
      background: #efefef;
    }
    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #333;
      min-height: 18px;
    }
    iframe {
      width: 100%;
      height: 260px;
      border: 3px inset #777;
      background: #fff;
    }
    .public-link-box {
      margin-top: 10px;
      font-size: 13px;
      background: #fff;
      padding: 8px;
      border: 1px dashed #555;
      direction: ltr;
      text-align: left;
      word-break: break-all;
    }
    .public-link-box span {
      font-weight: bold;
      color: #0033aa;
    }
    .small-note {
      font-size: 11px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="shell">
  <div class="titlebar">
    <div class="titlebar-left">
      <img src="https://www.w3.org/Icons/WWW/w3c_home_nb" alt="" width="20" height="20">
      <span>Web90 - i21 On-Chain Personal Page</span>
    </div>
    <div class="win-btns">
      <div class="win-btn"></div>
      <div class="win-btn"></div>
      <div class="win-btn"></div>
    </div>
  </div>

  <div class="inner">
    <h1>
      ğŸŒ Web90 â€” On-Chain HTML Page
      <span>Ù†Ø³Ø®Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ† Ø´Ø®ØµÛŒ i21</span>
    </h1>

    <button id="connectBtn" class="btn">ğŸ”Œ Ø§ØªØµØ§Ù„ MetaMask</button>
    <div id="walletInfo" class="status"></div>

    <div class="section">
      <label for="titleInput">Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ù‡:</label>
      <input id="titleInput" placeholder="Ù…Ø«Ø§Ù„: i21 test one">

      <label for="htmlInput">HTML ØµÙØ­Ù‡:</label>
      <textarea id="htmlInput"><h1>Ø³Ù„Ø§Ù… i21 ğŸ‘‹</h1>
<p>Ø§ÛŒÙ† Ø§ÙˆÙ„ÛŒÙ† ØµÙØ­Ù‡ Ù…Ù† Ø±ÙˆÛŒ Web90 Ø§Ø³Øª.</p>
<p><b>Ø¯Ù‡Ù‡ Û¹Û°</b> Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ† Ø´Ø®ØµÛŒ!</p></textarea>

      <button id="publishBtn" class="btn">ğŸš€ Ø°Ø®ÛŒØ±Ù‡ / Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ†</button>
      <div id="status" class="status"></div>

      <div id="publicBox" class="public-link-box" style="display:none;">
        <div>ğŸ”— Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ ØµÙØ­Ù‡ Ø´Ù…Ø§:</div>
        <div><span id="publicUrl"></span></div>
        <div class="small-note">Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù† / Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø³ØªÙ‚ÛŒÙ… ØµÙØ­Ù‡â€ŒÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ù†Ø¯.</div>
      </div>
    </div>

    <div class="section">
      <strong>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ†:</strong>
      <iframe id="preview"></iframe>
    </div>
  </div>
</div>

<script>
  const CONTRACT_ADDRESS = "0xB581C9264f59BF0289fA76D61B2D0746dCE3C30D";
  const ABI = [
    "function createOrUpdatePage(string title, string html) external",
    "function getPage(address owner) view returns (string title, string html, uint256 lastUpdate)"
  ];

  let provider;
  let signer;
  let contract;
  let currentAddress;

  const connectBtn   = document.getElementById("connectBtn");
  const walletInfo   = document.getElementById("walletInfo");
  const publishBtn   = document.getElementById("publishBtn");
  const statusEl     = document.getElementById("status");
  const previewFrame = document.getElementById("preview");
  const publicBox    = document.getElementById("publicBox");
  const publicUrlEl  = document.getElementById("publicUrl");

  function makePublicUrl(addr) {
    const origin = window.location.origin;
    // ÙØ±Ø¶: ÙØ§ÛŒÙ„ viewer Ø¯Ø± Ø±ÙˆØª Ø¯Ø§Ù…Ù†Ù‡ Ø§Ø³Øª
    return `${origin}/web90-view.html?user=${addr}`;
  }

  async function connectWallet() {
    if (!window.ethereum) {
      alert("MetaMask Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
      return;
    }
    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(window.ethereum);
      signer   = await provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      currentAddress = await signer.getAddress();

      walletInfo.textContent = "Ø¢Ø¯Ø±Ø³ Ù…ØªØµÙ„: " + currentAddress;
      connectBtn.textContent = "âœ… Ù…ØªØµÙ„ Ø´Ø¯";

      const url = makePublicUrl(currentAddress);
      publicUrlEl.textContent = url;
      publicUrlEl.onclick = () => window.open(url, "_blank");
      publicBox.style.display = "block";

      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
      await loadMyPage();
    } catch (err) {
      console.error(err);
      walletInfo.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„";
    }
  }

  async function publishPage() {
    if (!signer || !contract) {
      alert("Ø§ÙˆÙ„ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.");
      return;
    }
    const title = document.getElementById("titleInput").value.trim();
    const html  = document.getElementById("htmlInput").value.trim();

    if (!title || !html) {
      alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ HTML Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯.");
      return;
    }

    try {
      statusEl.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´...";
      const tx = await contract.createOrUpdatePage(title, html);
      await tx.wait();
      statusEl.textContent = "âœ… ØµÙØ­Ù‡ Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.";

      await loadMyPage();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´";
    }
  }

  async function loadMyPage() {
    try {
      if (!currentAddress || !contract) return;
      const page = await contract.getPage(currentAddress);
      const html = page[1];
      if (html && html.length > 0) {
        previewFrame.srcdoc = html;
        statusEl.textContent = "ğŸ“¡ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø±ÙˆÛŒ Ø¨Ù„Ø§Ú©â€ŒÚ†ÛŒÙ† Ù„ÙˆØ¯ Ø´Ø¯.";
      }
    } catch (err) {
      console.error(err);
    }
  }

  connectBtn.addEventListener("click", connectWallet);
  publishBtn.addEventListener("click", publishPage);
</script>

</body>
</html>
